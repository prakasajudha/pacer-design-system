@namespace Pertamina.DesignSystem.Blazor
@inherits ComponentBase
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web

<div class="@GetWrapperClasses()" @attributes="AdditionalAttributes">
    @if (!string.IsNullOrWhiteSpace(Name))
    {
        <input
            type="radio"
            name="@Name"
            value="@Value"
            checked="@IsChecked"
            disabled="@Disabled"
            class="sr-only"
            id="@Id"
            @onchange="HandleChange" />
    }

    <button
        type="button"
        class="@GetRadioClasses()"
        style="@GetRadioStyle()"
        id="@(Id != null ? $"{Id}-button" : null)"
        role="radio"
        aria-checked="@IsChecked"
        aria-disabled="@(Disabled ? "true" : null)"
        aria-invalid="@(Error ? "true" : null)"
        aria-labelledby="@GetLabelId()"
        aria-describedby="@GetDescId()"
        disabled="@Disabled"
        @onclick="HandleToggle"
        @onclick:stopPropagation="true"
        @onkeydown="HandleKeyDown"
        @onfocus="HandleFocus"
        @onblur="HandleBlur">
        <span class="sr-only">Radio</span>
        @if (IsChecked)
        {
            <!-- Dot icon (checked state) -->
            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-white pointer-events-none"></div>
        }
    </button>

    @if (!string.IsNullOrWhiteSpace(Label) || !string.IsNullOrWhiteSpace(Description))
    {
        <div
            class="@GetContentClasses()"
            @onclick="HandleToggle"
            @onkeydown="HandleContentKeyDown"
            tabindex="0"
            role="button"
            aria-label="@(Label ?? "Toggle radio")">
            @if (!string.IsNullOrWhiteSpace(Label))
            {
                <div id="@GetLabelId()" class="@GetLabelClasses()" style="overflow-wrap: anywhere; word-break: break-word;">@Label</div>
            }
            @if (!string.IsNullOrWhiteSpace(Description))
            {
                <div id="@GetDescId()" class="@GetDescriptionClasses()" style="overflow-wrap: anywhere; word-break: break-word;">@Description</div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public object? SelectedValue { get; set; }
    [Parameter] public EventCallback<object?> SelectedValueChanged { get; set; }

    [Parameter] public object Value { get; set; } = null!;

    [Parameter] public EventCallback<object> OnChange { get; set; }

    [Parameter] public bool Disabled { get; set; } = false;
    [Parameter] public string? Name { get; set; }
    [Parameter] public string? Id { get; set; }
    [Parameter] public string? Label { get; set; }
    [Parameter] public string? Description { get; set; }
    [Parameter] public RadioPosition Position { get; set; } = RadioPosition.Left;
    [Parameter] public bool Outlined { get; set; } = false;
    [Parameter] public bool Error { get; set; } = false;

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private bool _isFocused = false;

    private string LabelId => string.IsNullOrWhiteSpace(Id) ? null : $"{Id}-label";
    private string DescId => string.IsNullOrWhiteSpace(Id) ? null : $"{Id}-description";

    private bool IsChecked => SelectedValue != null && SelectedValue.Equals(Value);

    private string GetWrapperClasses()
    {
        var hasContent = !string.IsNullOrWhiteSpace(Label) || !string.IsNullOrWhiteSpace(Description);

        var classes = new List<string>
        {
            "flex items-start",
            Position == RadioPosition.Right ? "flex-row-reverse justify-between" : "gap-2",
            Outlined ? "border rounded-lg p-4 gap-4" : "p-0",
            Outlined && !hasContent ? "p-0 border-0" : "",
            Disabled ? "opacity-50 cursor-not-allowed" : "cursor-pointer"
        };

        if (Outlined)
        {
            classes.Add(Error ? "border-error-500" : "border-slate-300");
        }

        return string.Join(" ", classes.Where(c => !string.IsNullOrWhiteSpace(c)));
    }

    private string GetRadioClasses()
    {
        var classes = new List<string>
        {
            "relative shrink-0 w-4 h-4 rounded-full",
            "border border-solid transition-colors duration-200 ease-out",
            "focus-visible:outline-none",
            IsChecked
                ? "border-[#016BF8]"
                : Error
                    ? "bg-white border-error-500"
                    : Disabled
                        ? "bg-slate-100 border-slate-300"
                        : "bg-white border-slate-300",
            !Disabled ? "cursor-pointer" : ""
        };

        return string.Join(" ", classes.Where(c => !string.IsNullOrWhiteSpace(c)));
    }

    private string GetRadioStyle()
    {
        var bgStyle = IsChecked ? "background-color: #016BF8;" : "";

        if (_isFocused)
        {
            // Focus ring: 2px white + 4px brand-300
            return $"{bgStyle} box-shadow: 0px 0px 0px 2px white, 0px 0px 0px 4px #016BF8;";
        }

        return bgStyle;
    }

    private string GetContentClasses()
    {
        return "flex flex-col gap-1 min-w-0 flex-1";
    }

    private string GetLabelClasses()
    {
        return Error ? "text-sm font-medium leading-none text-error-600" : "text-sm font-medium leading-none text-slate-950";
    }

    private string GetDescriptionClasses()
    {
        return "text-sm font-normal leading-5 text-slate-500";
    }

    private string GetLabelId() => LabelId ?? string.Empty;
    private string GetDescId() => DescId ?? string.Empty;

    private async Task HandleToggle()
    {
        if (Disabled) return;
        SelectedValue = Value;
        if (SelectedValueChanged.HasDelegate) await SelectedValueChanged.InvokeAsync(SelectedValue);
        if (OnChange.HasDelegate) await OnChange.InvokeAsync(Value);
    }

    private async Task HandleChange(ChangeEventArgs e)
    {
        if (Disabled) return;
        await HandleToggle();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (Disabled) return;
        if (e.Key == "Enter" || e.Key == " ")
        {
            e.PreventDefault();
            await HandleToggle();
        }
    }

    private async Task HandleContentKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            e.PreventDefault();
            await HandleToggle();
        }
    }

    private void HandleFocus()
    {
        _isFocused = true;
    }

    private void HandleBlur()
    {
        _isFocused = false;
    }
}
