@namespace Pertamina.DesignSystem.Blazor
@inherits ComponentBase
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web

<button
    type="button"
    class="@GetTriggerClasses()"
    style="@GetTriggerStyle()"
    disabled="@Disabled"
    aria-selected="@IsSelected"
    aria-disabled="@(Disabled ? "true" : null)"
    role="tab"
    @onclick="HandleClick"
    @onkeydown="HandleKeyDown"
    @attributes="AdditionalAttributes">
    @ChildContent
</button>

@code {
    [CascadingParameter(Name = "TabsContext")]
    public PtTabs? Tabs { get; set; }

    [CascadingParameter(Name = "TabsListContext")]
    public PtTabsList? TabsList { get; set; }

    [Parameter] public RenderFragment? ChildContent { get; set; }

    [Parameter] public object Value { get; set; } = null!;

    [Parameter] public bool Disabled { get; set; } = false;

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private bool IsSelected => Tabs?.ActiveValue?.Equals(Value) ?? false;

    private string GetTriggerClasses()
    {
        var variant = Tabs?.CurrentVariant ?? TabsVariant.Default;
        var stretch = TabsList?.Stretch ?? false;

        var classes = new List<string>
        {
            "flex items-center justify-center min-w-[56px] relative transition-colors duration-200 ease-out",
            stretch ? "" : "shrink-0"
        };

        if (variant == TabsVariant.Default)
        {
            classes.Add("px-3 py-1.5 rounded-md");
            if (IsSelected)
            {
                classes.Add("bg-white font-medium leading-5 shadow-sm");
            }
            else
            {
                classes.Add("bg-transparent text-slate-500 font-normal leading-5");
            }
        }
        else
        {
            classes.Add("px-4 pt-2 pb-3.5 text-sm");
            if (IsSelected)
            {
                classes.Add("border-b-2 font-semibold leading-none");
            }
            else
            {
                classes.Add("border-b-2 border-transparent text-slate-500 font-normal leading-none");
            }
        }

        if (!Disabled)
        {
            classes.Add("cursor-pointer");
        }
        else
        {
            classes.Add("opacity-50 cursor-not-allowed");
        }

        return string.Join(" ", classes);
    }

    private string GetTriggerStyle()
    {
        var variant = Tabs?.CurrentVariant ?? TabsVariant.Default;
        if (IsSelected)
        {
            if (variant == TabsVariant.Default)
            {
                return "color: #016BF8;";
            }
            else
            {
                return "border-color: #016BF8; color: #016BF8; margin-bottom: -1px;";
            }
        }
        if (variant == TabsVariant.Line)
        {
            return "margin-bottom: -1px;";
        }
        return string.Empty;
    }

    private async Task HandleClick()
    {
        if (Disabled || Tabs == null) return;
        await Tabs.SetActiveValue(Value);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (Disabled || Tabs == null) return;
        if (e.Key == "Enter" || e.Key == " ")
        {
            e.PreventDefault();
            await Tabs.SetActiveValue(Value);
        }
    }
}
