@namespace Pertamina.DesignSystem.Blazor
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using System.Collections.Generic
@using System.Threading
@inherits ComponentBase
@implements IDisposable

<div class="flex flex-col gap-1.5">
    @if (TitleContent != null)
    {
        <label class="block w-full text-sm font-medium text-slate-700">@TitleContent</label>
    }
    else if (!string.IsNullOrEmpty(Title))
    {
        <label class="block w-full text-sm font-medium text-slate-700">@Title</label>
    }

    <div class="flex w-full items-center justify-start @GetGapClass()">
        <div class="flex items-center @GetGapClass()">
            @for (var i = 0; i < Length; i++)
            {
                var idx = i;
                <input type="text"
                       inputmode="numeric"
                       autocomplete="one-time-code"
                       maxlength="1"
                       disabled="@Disabled"
                       aria-label="@($"Digit {idx + 1}")"
                       class="inline-flex items-center justify-center rounded-md border border-solid bg-white text-center font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:bg-slate-50 disabled:text-slate-400 @GetBoxClass() @GetInputStateClass()"
                       value="@GetDisplayValue(idx)"
                       @oninput="e => HandleInput(idx, e)"
                       @onkeydown="e => HandleKeyDown(idx, e)" />
            }
        </div>
    </div>

    @if (DescriptionContent != null && !Error)
    {
        <label class="block w-full text-sm font-normal leading-5 text-slate-500">@DescriptionContent</label>
    }
    else if (!string.IsNullOrEmpty(Description) && !Error)
    {
        <label class="block w-full text-sm font-normal leading-5 text-slate-500">@Description</label>
    }
    @if (Error && !string.IsNullOrEmpty(ErrorMessage))
    {
        <label class="block w-full text-sm text-error-600" role="alert">@ErrorMessage</label>
    }
</div>

@code {
    private const int RevealMs = 500;
    private bool _maskVisible;
    private readonly HashSet<int> _revealingIndices = new();
    private readonly Dictionary<int, CancellationTokenSource> _revealCtsByIndex = new();

    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public int Length { get; set; } = 4;
    [Parameter] public PinInputSize Size { get; set; } = PinInputSize.Medium;
    [Parameter] public bool Mask { get; set; } = true;
    /// <summary>Label di atas. String atau isi RenderFragment (komponen/kustom).</summary>
    [Parameter] public string? Title { get; set; }
    [Parameter] public RenderFragment? TitleContent { get; set; }
    /// <summary>Teks bantuan di bawah. String atau RenderFragment. Tidak ditampilkan saat error.</summary>
    [Parameter] public string? Description { get; set; }
    [Parameter] public RenderFragment? DescriptionContent { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool Error { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }

    private const char EmptyChar = ' ';

    private string GetValueStr()
    {
        var s = (Value ?? "").Where(c => char.IsDigit(c) || c == EmptyChar).Take(Length);
        return new string(s).PadRight(Length, EmptyChar);
    }

    private string GetDisplayValue(int idx)
    {
        var cur = GetValueStr();
        var c = idx < cur.Length ? cur[idx] : EmptyChar;
        if (Mask && !_maskVisible && !_revealingIndices.Contains(idx) && c != EmptyChar) return "•";
        return c == EmptyChar ? "" : c.ToString();
    }

    private void StartRevealTimeout(int idx)
    {
        if (_revealCtsByIndex.TryGetValue(idx, out var existing))
        {
            existing.Cancel();
            existing.Dispose();
            _revealCtsByIndex.Remove(idx);
        }
        _revealingIndices.Add(idx);
        StateHasChanged();
        var cts = new CancellationTokenSource();
        _revealCtsByIndex[idx] = cts;
        _ = RunRevealTimerAsync(idx, cts.Token);
    }

    private async Task RunRevealTimerAsync(int idx, CancellationToken token)
    {
        try
        {
            await Task.Delay(RevealMs, token);
        }
        catch (OperationCanceledException)
        {
            return;
        }
        if (token.IsCancellationRequested) return;
        _revealingIndices.Remove(idx);
        _revealCtsByIndex.Remove(idx);
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        foreach (var cts in _revealCtsByIndex.Values)
        {
            cts.Cancel();
            cts.Dispose();
        }
        _revealCtsByIndex.Clear();
    }

    private string GetBoxClass() => Size switch
    {
        PinInputSize.Small => "w-9 h-9 text-sm",
        PinInputSize.Large => "w-12 h-12 text-lg",
        _ => "w-10 h-10 text-base"
    };

    private string GetGapClass() => Size == PinInputSize.Large ? "gap-3" : "gap-2";

    private string GetInputStateClass() => Error
        ? "border-solid border-error-500 focus:border-error-500 focus:ring-error-500 focus-visible:ring-error-500"
        : "border-solid border-slate-300 focus:ring-brand-300 focus-visible:ring-brand-300";

    private static string SanitizePositionBased(string s, int maxLen)
    {
        var t = new string(s.Where(c => char.IsDigit(c) || c == EmptyChar).Take(maxLen).ToArray());
        return t.PadRight(maxLen, EmptyChar);
    }

    private async Task SetValue(string v)
    {
        var next = SanitizePositionBased(v, Length);
        Value = next;
        await ValueChanged.InvokeAsync(next);
    }

    private async Task HandleInput(int idx, ChangeEventArgs e)
    {
        var raw = (e.Value?.ToString() ?? "").Replace("•", "");
        var v = new string(raw.Where(char.IsDigit).Take(1).ToArray());
        if (raw.Length > 1)
        {
            var cur = GetValueStr();
            var merged = cur.Length > idx ? cur.Substring(0, idx) + (v.Length > 0 ? v[^1].ToString() : "") + cur.Substring(idx + 1) : cur;
            await SetValue(merged);
            if (Mask && v.Length > 0) StartRevealTimeout(idx);
            return;
        }
        var cur2 = GetValueStr();
        var ch = v.Length > 0 ? v[0] : EmptyChar;
        var next = (idx < cur2.Length ? cur2.Substring(0, idx) + ch + cur2.Substring(idx + 1) : cur2).PadRight(Length, EmptyChar).Substring(0, Length);
        await SetValue(next);
        if (Mask) StartRevealTimeout(idx);
    }

    private async Task HandleKeyDown(int idx, KeyboardEventArgs e)
    {
        if (e.Key != "Backspace") return;
        var cur = GetValueStr();
        var hasDigit = idx < cur.Length && cur[idx] != EmptyChar;
        if (hasDigit)
        {
            var next = cur.Substring(0, idx) + EmptyChar + (idx + 1 < cur.Length ? cur.Substring(idx + 1) : "");
            await SetValue(next);
            return;
        }
        if (idx > 0)
        {
            var next = cur.Substring(0, idx - 1) + EmptyChar + (idx < cur.Length ? cur.Substring(idx) : "");
            await SetValue(next);
        }
    }

}
