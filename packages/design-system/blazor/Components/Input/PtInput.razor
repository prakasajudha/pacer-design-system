@namespace Pertamina.DesignSystem.Blazor
@inherits ComponentBase
@typeparam TValue

<div class="@GetContainerClasses()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <label for="@InputId" class="block text-sm font-medium text-neutral-700">
            @Label
        </label>
    }
    
    <div class="relative">
        @if (StartIcon != null)
        {
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-neutral-500">
                @StartIcon
            </div>
        }
        
        <input 
            id="@InputId"
            type="@GetInputType()"
            class="@GetInputClasses()"
            value="@Value"
            placeholder="@Placeholder"
            disabled="@Disabled"
            @oninput="HandleInput"
            @attributes="AdditionalAttributes" />
        
        @if (EndIcon != null)
        {
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-neutral-500">
                @EndIcon
            </div>
        }
    </div>
    
    @if (!string.IsNullOrEmpty(Error))
    {
        <p class="text-sm text-error-600" role="alert">
            @Error
        </p>
    }
    else if (!string.IsNullOrEmpty(HelperText))
    {
        <p class="text-sm text-neutral-500">
            @HelperText
        </p>
    }
</div>

@code {
    private string InputId { get; set; } = $"input-{Guid.NewGuid():N}";

    /// <summary>
    /// Input value
    /// </summary>
    [Parameter]
    public TValue? Value { get; set; }

    /// <summary>
    /// Value changed callback
    /// </summary>
    [Parameter]
    public EventCallback<TValue> ValueChanged { get; set; }

    /// <summary>
    /// Label text
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Error message
    /// </summary>
    [Parameter]
    public string? Error { get; set; }

    /// <summary>
    /// Helper text
    /// </summary>
    [Parameter]
    public string? HelperText { get; set; }

    /// <summary>
    /// Placeholder text
    /// </summary>
    [Parameter]
    public string? Placeholder { get; set; }

    /// <summary>
    /// Input type
    /// </summary>
    [Parameter]
    public InputType Type { get; set; } = InputType.Text;

    /// <summary>
    /// Full width input
    /// </summary>
    [Parameter]
    public bool FullWidth { get; set; } = false;

    /// <summary>
    /// Disabled state
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; } = false;

    /// <summary>
    /// Icon before input
    /// </summary>
    [Parameter]
    public RenderFragment? StartIcon { get; set; }

    /// <summary>
    /// Icon after input
    /// </summary>
    [Parameter]
    public RenderFragment? EndIcon { get; set; }

    /// <summary>
    /// Additional HTML attributes
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private string GetContainerClasses()
    {
        var classes = new List<string> { "space-y-1" };
        if (FullWidth)
        {
            classes.Add("w-full");
        }
        return string.Join(" ", classes);
    }

    private string GetInputClasses()
    {
        var classes = new List<string>
        {
            "input",
            "block",
            "px-3",
            "py-2",
            "border",
            "rounded-md",
            "shadow-sm",
            "transition-colors",
            "focus:outline-none",
            "focus:ring-2",
            "focus:ring-offset-0"
        };

        if (!string.IsNullOrEmpty(Error))
        {
            classes.Add("border-error-500 focus:border-error-500 focus:ring-error-200");
        }
        else
        {
            classes.Add("border-neutral-300 focus:border-brand-primary-500 focus:ring-brand-primary-200");
        }

        if (StartIcon != null)
        {
            classes.Add("pl-10");
        }

        if (EndIcon != null)
        {
            classes.Add("pr-10");
        }

        if (FullWidth)
        {
            classes.Add("w-full");
        }

        return string.Join(" ", classes);
    }

    private string GetInputType()
    {
        return Type switch
        {
            InputType.Email => "email",
            InputType.Password => "password",
            InputType.Number => "number",
            InputType.Tel => "tel",
            InputType.Url => "url",
            InputType.Search => "search",
            InputType.Date => "date",
            _ => "text"
        };
    }

    private async Task HandleInput(ChangeEventArgs e)
    {
        if (e.Value != null)
        {
            var value = (TValue)Convert.ChangeType(e.Value, typeof(TValue));
            Value = value;
            await ValueChanged.InvokeAsync(value);
        }
    }
}
