# CI Pipeline — PACER Design System (React, Vue, Blazor)
# Satu alur: CI → SAST (Semgrep) → DAST (ZAP). Jika CI gagal, SAST & DAST tidak jalan.
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-build-test:
    name: Lint, Build & Test (Node)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Security audit (dependency check)
        run: pnpm audit --audit-level high
        # Fails only on high/critical. Moderate (eslint, vue-template-compiler) require larger migration; see package.json pnpm.overrides + docs.

      - name: Lint
        run: pnpm run lint

      - name: Build (React, Vue, Tailwind, Tokens, Storybook)
        run: pnpm run build

      - name: Unit test (React, Vue)
        run: pnpm run test

  blazor-build:
    name: Build Blazor
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore & Build Blazor
        run: |
          dotnet restore packages/design-system/blazor/Pertamina.DesignSystem.Blazor.csproj
          dotnet build packages/design-system/blazor/Pertamina.DesignSystem.Blazor.csproj --configuration Release
        working-directory: ${{ github.workspace }}

  smoke-playwright:
    name: Smoke Test (Playwright)
    runs-on: ubuntu-latest
    needs: lint-build-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies (tokens, tailwind-preset, react, vue)
        run: |
          pnpm --filter @pacer-ui/tokens build
          pnpm --filter @pacer-ui/tailwind-preset build
          pnpm --filter @pacer-ui/react build
          pnpm --filter @pacer-ui/vue build

      - name: Build Storybook (React & Vue)
        run: |
          pnpm --filter @pacer-ui/storybook-react build
          pnpm --filter @pacer-ui/storybook-vue build

      - name: Install Playwright
        run: pnpm exec playwright install --with-deps chromium

      - name: Run Playwright smoke tests (React)
        run: |
          pnpm exec serve packages/storybook/react/storybook-static -l 6006 &
          for i in $(seq 1 60); do curl -sf http://127.0.0.1:6006 >/dev/null && break; sleep 1; done
          pnpm exec playwright test --project=storybook-react
      - name: Run Playwright smoke tests (Vue)
        run: |
          pnpm exec serve packages/storybook/vue/storybook-static -l 6007 &
          for i in $(seq 1 60); do curl -sf http://127.0.0.1:6007 >/dev/null && break; sleep 1; done
          pnpm exec playwright test --project=storybook-vue

  sast-semgrep:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    needs: lint-build-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/src" \
            -w /src \
            semgrep/semgrep semgrep scan \
            --config auto \
            --metrics=off \
            --json --json-output=semgrep-results.json \
            --error
        continue-on-error: true

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('semgrep-results.json') != ''
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30
          if-no-files-found: ignore

  dast-zap:
    name: DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: sast-semgrep
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies (tokens, tailwind, react)
        run: |
          pnpm --filter @pacer-ui/tokens build
          pnpm --filter @pacer-ui/tailwind-preset build
          pnpm --filter @pacer-ui/react build

      - name: Build Storybook (React)
        run: pnpm --filter @pacer-ui/storybook-react build

      - name: Serve Storybook
        run: |
          pnpm exec serve packages/storybook/react/storybook-static -l 3000 &
          for i in $(seq 1 60); do curl -sf http://127.0.0.1:3000 >/dev/null && break; sleep 1; done
          curl -sf http://127.0.0.1:3000 >/dev/null || exit 1

      - name: Smoke check (gate sebelum DAST)
        run: |
          PREVIEW_URL="http://127.0.0.1:3000/iframe.html?viewMode=story&id=components-button--playground"
          RESP=$(curl -sf -o /tmp/preview.html -w "%{http_code}" "$PREVIEW_URL")
          [ "$RESP" = "200" ] || (echo "Smoke check failed: preview returned $RESP"; exit 1)
          grep -q "storybook-root\|Primary Action\|storybook" /tmp/preview.html || (echo "Smoke check failed: preview body invalid"; exit 1)
          echo "Smoke check passed: app is alive, proceeding to ZAP."

      - name: Run OWASP ZAP Baseline Scan
        run: |
          mkdir -p zap-output
          docker run --rm \
            --network host \
            -v "${{ github.workspace }}/zap-output:/zap/wrk:rw" \
            -w /zap/wrk \
            -e JAVA_OPTS="-Xmx2g" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://127.0.0.1:3000 \
            -r zap-baseline-report.html \
            -I
        continue-on-error: true

      - name: Check for ZAP report
        id: zap-report
        if: always()
        run: |
          if [ -f zap-output/zap-baseline-report.html ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        if: always() && steps.zap-report.outputs.exists == 'true'
        with:
          name: zap-baseline-report
          path: zap-output/zap-baseline-report.html
          retention-days: 30
          if-no-files-found: ignore
