# DAST â€” OWASP ZAP Baseline Scan
# Scan Storybook (React) yang di-serve secara lokal
name: DAST (OWASP ZAP)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Jalan mingguan (Selasa 00:00 UTC)
    - cron: '0 0 * * 2'

jobs:
  zap-baseline:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies (tokens, tailwind, react)
        run: |
          pnpm --filter @pacer-ui/tokens build
          pnpm --filter @pacer-ui/tailwind-preset build
          pnpm --filter @pacer-ui/react build

      - name: Build Storybook (React)
        run: pnpm --filter @pacer-ui/storybook-react build

      - name: Serve Storybook
        run: |
          pnpm exec serve packages/storybook/react/storybook-static -l 3000 &
          for i in $(seq 1 60); do curl -sf http://127.0.0.1:3000 >/dev/null && break; sleep 1; done
          curl -sf http://127.0.0.1:3000 >/dev/null || exit 1

      - name: Run OWASP ZAP Baseline Scan
        run: |
          mkdir -p zap-output
          docker run --rm \
            --network host \
            -v "${{ github.workspace }}/zap-output:/zap/wrk:rw" \
            -e JAVA_OPTS="-Xmx2g" \
            owasp/zap2docker-stable \
            zap-baseline.py \
            -t http://127.0.0.1:3000 \
            -r /zap/wrk/zap-baseline-report.html \
            -I
        continue-on-error: true
        # -I = ignore warning rules (reduce false positives). Hapus -I untuk fail on findings.

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report
          path: zap-output/
          retention-days: 30
