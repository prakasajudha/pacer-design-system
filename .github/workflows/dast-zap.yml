# DAST — OWASP ZAP Baseline Scan
# Urutan benar: Build → Serve → Smoke check → ZAP (never scan a dead app)
name: DAST (OWASP ZAP)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Jalan mingguan (Selasa 00:00 UTC)
    - cron: '0 0 * * 2'

jobs:
  zap-baseline:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies (tokens, tailwind, react)
        run: |
          pnpm --filter @pacer-ui/tokens build
          pnpm --filter @pacer-ui/tailwind-preset build
          pnpm --filter @pacer-ui/react build

      - name: Build Storybook (React)
        run: pnpm --filter @pacer-ui/storybook-react build

      - name: Serve Storybook
        run: |
          pnpm exec serve packages/storybook/react/storybook-static -l 3000 &
          for i in $(seq 1 60); do curl -sf http://127.0.0.1:3000 >/dev/null && break; sleep 1; done
          curl -sf http://127.0.0.1:3000 >/dev/null || exit 1

      - name: Smoke check (gate sebelum DAST)
        run: |
          # Never scan a dead app: validasi app hidup & preview bisa di-load
          PREVIEW_URL="http://127.0.0.1:3000/iframe.html?viewMode=story&id=components-button--playground"
          RESP=$(curl -sf -o /tmp/preview.html -w "%{http_code}" "$PREVIEW_URL")
          [ "$RESP" = "200" ] || (echo "Smoke check failed: preview returned $RESP"; exit 1)
          grep -q "storybook-root\|Primary Action\|storybook" /tmp/preview.html || (echo "Smoke check failed: preview body invalid"; exit 1)
          echo "Smoke check passed: app is alive, proceeding to ZAP."

      - name: Run OWASP ZAP Baseline Scan
        id: zap
        run: |
          mkdir -p zap-output
          docker run --rm \
            --network host \
            -v "${{ github.workspace }}/zap-output:/zap/wrk:rw" \
            -w /zap/wrk \
            -e JAVA_OPTS="-Xmx2g" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t http://127.0.0.1:3000 \
            -r zap-baseline-report.html \
            -I
        continue-on-error: true
        # Image: ghcr.io/zaproxy/zaproxy (resmi, GHCR). -w /zap/wrk agar report ke mount.
        # -I = ignore warning rules (reduce false positives). Hapus -I untuk fail on findings.

      - name: List ZAP output (debug)
        if: always()
        run: ls -la zap-output/ || true

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('zap-output/zap-baseline-report.html') != ''
        with:
          name: zap-baseline-report
          path: zap-output/zap-baseline-report.html
          retention-days: 30
